# 11_marketplace_alignment_linux_first_security

## Что было сделано

- В `hostagent` исправлена модель телеметрии CPU: `cpu_free_cores` теперь считается по фактической свободной мощности, а не по `runtime.NumCPU()`.
- GPU-модель расширена с бинарного факта наличия до инвентаризации: `gpu_total_units`, `gpu_memory_total_mb`, `gpu_memory_used_mb`, плюс пересчет `gpu_free_units`.
- Реализован Linux-first сбор метрик с платформенными разделителями (`collector_linux.go` и `collector_unsupported.go`), чтобы на неподдерживаемых ОС поведение было явным.
- Контракт heartbeat синхронизирован с `resourceservice` (модель + SQL миграция/апсерты/чтение).
- Добавлены guardrails для аллокаций: проверка свежести heartbeat и валидация ресурсного снапшота перед `Allocate`.
- Для telemetry endpoints (`/heartbeat`, `/agent-logs`) добавлена проверка identity агента: роль `agent` + совпадение `provider_id` с токеном (с админ-исключениями).
- Обновлены README/release/installer формулировки под честный Linux-first MVP и границы security-модели.

## Почему так сделано

- Заявление “маркетплейс простаивающих ПК” должно опираться на достоверную телеметрию, иначе аллокации становятся недетерминированными.
- Linux-specific источники (`/proc/*`) нельзя выдавать за кроссплатформенную реализацию без явного ограничения.
- Для хакатонного MVP критично не переобещать secure execution там, где реализован control-plane и учет лимитов.

## С какими трудностями столкнулся

- Требовалось расширить телеметрический контракт без поломки текущей схемы БД и существующих heartbeat потоков.
- Нужна была совместимость с текущей JWT-моделью, где роль/идентификатор агента не выделены отдельным типом токена.
- Часть runtime-компонентов (оркестратор) имеет intentionally lightweight реализацию, которую нужно документировать аккуратно, без двусмысленности.

## Какие решения принял

- Для CPU использован расчет свободных ядер на основе снапшотов `/proc/stat` с fallback на `loadavg`, чтобы первая отправка тоже была осмысленной.
- Для GPU выбран практичный путь: `nvidia-smi` как основной источник и fallback на `/proc/driver/nvidia/gpus` для count-only сценария.
- Для БД выбран безопасный путь расширения схемы через `ADD COLUMN IF NOT EXISTS`.
- Для identity guard выбран строгий режим для роли `agent` и управляемые исключения для административных ролей.

## План на следующую итерацию

- Вынести identity агента в отдельный тип service token с явным issuer/audience и ротацией.
- Добавить end-to-end тесты heartbeat->allocate с проверкой stale/identity отклонений.
- Расширить GPU телеметрию до per-device метрик (utilization, temperature, power) и учитывать их в планировщике.
- Спроектировать execution plane с изоляцией (sandbox/VM/TEE) как отдельный этап архитектуры.
