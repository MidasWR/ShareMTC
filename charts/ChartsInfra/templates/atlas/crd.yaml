{{- if .Values.atlas.migration.enabled }}
apiVersion: db.atlasgo.io/v1alpha1
kind: AtlasMigration
metadata:
  name: host-atlas
  namespace: {{ .Values.global.namespace }}
spec:
  baseline: "202602240001"
{{- if .Values.atlas.migration.revisionsSchema }}
  revisionsSchema: {{ .Values.atlas.migration.revisionsSchema | quote }}
{{- end }}
  credentials:
    scheme: postgres
    host: {{ printf "%s.%s.svc.cluster.local" .Values.postgres.dns .Values.global.namespace | quote }}
    port: {{ .Values.atlas.migration.port }}
    database: {{ .Values.atlas.migration.database | quote }}
    parameters:
      sslmode: {{ .Values.atlas.migration.sslmode | quote }}
{{- if .Values.atlas.migration.searchPath }}
      search_path: {{ .Values.atlas.migration.searchPath | quote }}
{{- end }}
    userFrom:
      secretKeyRef:
        name: {{ .Values.atlas.migration.credentialsSecretName }}
        key: {{ .Values.atlas.migration.usernameKey }}
    passwordFrom:
      secretKeyRef:
        name: {{ .Values.atlas.migration.credentialsSecretName }}
        key: {{ .Values.atlas.migration.passwordKey }}
  devURL: {{ printf "postgres://%s:%s@localhost:%v/%s?sslmode=disable" .Values.atlas.migration.devdb.user .Values.atlas.migration.devdb.password .Values.atlas.migration.devdb.port .Values.atlas.migration.devdb.database | quote }}
  devDB:
    spec:
      containers:
        - name: dev-db
          image: {{ .Values.atlas.migration.devdb.image | quote }}
          env:
            - name: POSTGRES_DB
              value: {{ .Values.atlas.migration.devdb.database | quote }}
            - name: POSTGRES_USER
              value: {{ .Values.atlas.migration.devdb.user | quote }}
            - name: POSTGRES_PASSWORD
              value: {{ .Values.atlas.migration.devdb.password | quote }}
          ports:
            - name: postgres
              containerPort: {{ .Values.atlas.migration.devdb.port }}
          startupProbe:
            exec:
              command: ["pg_isready", "-h", "127.0.0.1", "-p", "{{ .Values.atlas.migration.devdb.port }}", "-U", "{{ .Values.atlas.migration.devdb.user }}"]
            failureThreshold: 30
            periodSeconds: 2
{{- if eq .Values.atlas.migration.mode "local" }}
  dir:
    configMapRef:
      name: {{ .Values.atlas.migration.configMapName | quote }}
{{- else }}
  dir:
    remote:
      name: {{ required "atlas.migration.remoteDirName is required when atlas.migration.mode=remote" .Values.atlas.migration.remoteDirName | quote }}
      tag: {{ .Values.atlas.migration.remoteDirTag | quote }}
{{- end }}
{{- end }}
